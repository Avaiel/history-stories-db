<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²ç­–é€»è¾‘è®­ç»ƒè¥ - æ´å¯Ÿå†å²èƒŒåçš„åšå¼ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .heat-cell { width: 10px; height: 10px; border-radius: 2px; transition: all 0.3s; }
        .bg-empty { background-color: #e2e8f0; }
        .bg-fill { background-color: #10b981; box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .logic-card { border-left: 4px solid #6366f1; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 min-h-screen pb-10">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center p-4">
            <h1 class="font-bold text-indigo-600 text-lg">ğŸ“œ å²ç­–é€»è¾‘</h1>
            <div class="flex gap-4 text-sm font-medium">
                <button onclick="showTab('today')" id="tab-today" class="text-indigo-600 border-b-2 border-indigo-600 pb-1">è®­ç»ƒ</button>
                <button onclick="showTab('history')" id="tab-history" class="text-gray-500 pb-1">å­˜æ¡£</button>
                <button onclick="showTab('stats')" id="tab-stats" class="text-gray-500 pb-1">æˆå°±</button>
            </div>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- ã€è®­ç»ƒé¡µã€‘ -->
        <section id="today" class="tab-content active space-y-6">
            <!-- ç§°å·å‹‹ç«  -->
            <div class="bg-gradient-to-br from-indigo-600 to-violet-700 rounded-2xl p-5 text-white shadow-xl">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs opacity-80 mb-1">å½“å‰é€»è¾‘å°å·</p>
                        <h2 id="user-title" class="text-2xl font-black tracking-wide">åˆå…¥å²æ—</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-xs opacity-80 mb-1">è¿ç»­æ‰“å¡</p>
                        <p class="text-2xl font-bold"><span id="streak-count">0</span> <span class="text-sm">å¤©</span></p>
                    </div>
                </div>
            </div>

            <!-- ä»Šæ—¥æ•…äº‹ -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 logic-card">
                <div class="flex justify-between items-center mb-4">
                    <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-[10px] font-bold rounded uppercase">Daily Insight</span>
                    <span id="current-date" class="text-xs text-gray-400 font-mono">2025-12-28</span>
                </div>
                <h3 id="story-title" class="text-xl font-bold mb-3 text-slate-800">æ­£åœ¨åŒæ­¥ GitHub å²åº“...</h3>
                <p id="story-content" class="text-gray-600 leading-relaxed text-sm italic mb-4"></p>
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">æ ¸å¿ƒé€»è¾‘æ·±åº¦ (AI è¯„åˆ†æ ‡å‡†)</p>
                    <p id="story-logic" class="text-xs text-slate-600 leading-normal"></p>
                </div>
            </div>

            <!-- å¤è¿°äº¤äº’åŒº -->
            <div class="space-y-4">
                <textarea id="user-input" class="w-full h-44 p-4 rounded-2xl bg-white border border-gray-200 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-400 outline-none transition-all text-sm shadow-inner" placeholder="ç‚¹å‡»ä¸‹æ–¹çš„è¯­éŸ³æŒ‰é’®å¼€å§‹å¤è¿°ï¼Œè®²å‡ºè¯¥æ•…äº‹èƒŒåçš„æ·±åº¦é€»è¾‘..."></textarea>
                
                <div class="flex gap-3">
                    <button id="btn-record" class="flex-[1] bg-white border border-gray-200 py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition shadow-sm">
                        <span id="mic-icon">ğŸ™ï¸</span> <span id="record-text">è¯­éŸ³å¤è¿°</span>
                    </button>
                    <button id="btn-submit" class="flex-[2] bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition">
                        ğŸ¤– AI é”è¯„
                    </button>
                </div>
            </div>

            <!-- AI åé¦ˆ -->
            <div id="ai-section" class="hidden">
                <div class="bg-slate-900 rounded-2xl p-6 shadow-2xl">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="flex h-2 w-2 rounded-full bg-green-400 animate-pulse"></span>
                        <h4 class="text-indigo-400 text-xs font-bold uppercase tracking-widest">Gemini é€»è¾‘åˆ¤å®˜</h4>
                    </div>
                    <div id="ai-feedback" class="text-slate-300 text-sm leading-relaxed whitespace-pre-line font-serif"></div>
                </div>
            </div>
        </section>

        <!-- ã€å­˜æ¡£é¡µã€‘ -->
        <section id="history" class="tab-content space-y-4">
            <h2 class="text-lg font-bold px-1">å¾€æ—¥æ·±åº¦å¤è¿°è®°å½•</h2>
            <div id="history-container" class="space-y-4"></div>
        </section>

        <!-- ã€æˆå°±é¡µã€‘ -->
        <section id="stats" class="tab-content space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="font-bold text-sm mb-4">é€»è¾‘è®­ç»ƒçƒ­åŠ›å›¾</h3>
                <div id="heatmap" class="grid grid-cols-7 gap-2 w-max"></div>
                <div class="mt-4 flex justify-between text-[10px] text-gray-400 italic">
                    <span>æœ€è¿‘30å¤©æŒ‘æˆ˜è®°å½•</span>
                    <span>ç»¿è‰²è¶Šæ·±æ€è€ƒè¶Šå‹¤</span>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="font-bold text-sm mb-4">å°å·è¿›é˜¶ä½“ç³»</h3>
                <div id="achievement-list" class="space-y-4"></div>
            </div>
        </section>
    </main>

    <script>
        /** é…ç½®åŒº **/
        const STORY_DATA_URL = 'https://raw.githubusercontent.com/Avaiel/history-stories-db/refs/heads/main/stories.json';
        const STORAGE_KEY = 'history_logic_pro_v2';
        const GEMINI_API_KEY = 'AIzaSyDPCSQ8aawRAL7jU4fjNPhmLW0WR3IWGFo'; 

        let userData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { records: {}, streak: 0, lastDate: null };
        let currentStory = null;

        /** åˆå§‹åŒ– **/
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDailyStory();
            updateDashboard();
            renderHeatmap();
            renderHistory();
        });

        /** æ ¸å¿ƒåŠŸèƒ½ï¼šè·å–æ•…äº‹ **/
        async function loadDailyStory() {
            try {
                const res = await fetch(STORY_DATA_URL);
                const stories = await res.json();
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                document.getElementById('current-date').innerText = dateStr;

                const seed = now.getFullYear() * 1000 + (now.getMonth() + 1) * 100 + now.getDate();
                currentStory = stories[seed % stories.length];

                document.getElementById('story-title').innerText = currentStory.title;
                document.getElementById('story-content').innerText = currentStory.content;
                document.getElementById('story-logic').innerText = currentStory.logic;

                if (userData.records[dateStr]) {
                    document.getElementById('user-input').value = userData.records[dateStr].userText;
                    document.getElementById('user-input').readOnly = true;
                    showAIResult(userData.records[dateStr].aiFeedback);
                    const btn = document.getElementById('btn-submit');
                    btn.innerText = "ä»Šæ—¥å·²æŒ‘æˆ˜";
                    btn.disabled = true;
                }
            } catch (e) {
                document.getElementById('story-title').innerText = "GitHub æ•°æ®æŠ“å–å¤±è´¥";
                console.error(e);
            }
        }

        /** æ ¸å¿ƒåŠŸèƒ½ï¼šGemini API æ¥å…¥ **/
        async function callGemini(input) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const prompt = `
                ä½ æ˜¯ä¸€ä½æ¯’èˆŒä¸”æ·±é‚ƒçš„å†å²åšå¼ˆè®ºä¸“å®¶ã€‚
                ä»»åŠ¡ï¼šå¯¹æ¯”ã€æ ‡å‡†é€»è¾‘ã€‘å’Œç”¨æˆ·çš„ã€å¤è¿°è®°å½•ã€‘ï¼Œç»™å‡ºçŠ€åˆ©çš„é€»è¾‘ç‚¹è¯„ã€‚
                
                ã€æ ‡å‡†é€»è¾‘ã€‘ï¼š${currentStory.logic}
                ã€ç”¨æˆ·å¤è¿°ã€‘ï¼š${input}
                
                è¯·æŒ‰ä»¥ä¸‹ç»“æ„å›ç­”ï¼š
                1. é€»è¾‘ç¼ºå¤±ï¼šæŒ‡å‡ºç”¨æˆ·å¤è¿°ä¸­æ¼æ‰çš„æœ€æ ¸å¿ƒçš„åšå¼ˆç‚¹ã€å› æœé“¾æˆ–äººæ€§åŠ¨æœºã€‚
                2. é”è¯„ï¼šç”¨ä¸€é’ˆè§è¡€ã€å¹½é»˜ä½†ä¸¥å‰çš„è¯è¯„ä»·å…¶é€»è¾‘èƒ½åŠ›ã€‚
                3. åˆ†æ•°ï¼šæ»¡åˆ†10åˆ†ï¼Œç»™å‡ºè¯„åˆ†ã€‚
                4. é€»è¾‘é‡æ„ï¼šç”¨ä¸€æ®µæå…¶ç²¾ç‚¼çš„è¯é‡æ–°ç¤ºèŒƒå¦‚ä½•æœ‰é€»è¾‘åœ°è¡¨è¿°è¿™ä¸ªæ•…äº‹ã€‚
            `;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 800 }
                    })
                });
                const data = await response.json();
                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    return data.candidates[0].content.parts[0].text;
                }
                return "åˆ¤å®˜æ— æ³•å›åº”ï¼Œè¯·æ£€æŸ¥ API Key æƒé™ã€‚";
            } catch (e) {
                return "è¿æ¥ Gemini å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒæˆ– Keyã€‚";
            }
        }

        document.getElementById('btn-submit').onclick = async () => {
            const userText = document.getElementById('user-input').value.trim();
            if (userText.length < 5) return alert("å¤è¿°å†…å®¹å¤ªå•è–„ï¼Œé€»è¾‘æ— æ³•å±•å¼€ã€‚");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "åˆ¤å®˜å®¡é˜…ä¸­...";
            btn.disabled = true;

            const feedback = await callGemini(userText);
            
            showAIResult(feedback);
            saveData(userText, feedback);
            btn.innerText = "æŒ‘æˆ˜å®Œæˆ";
        };

        /** è¯­éŸ³è¯†åˆ« **/
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            let isRecording = false;

            document.getElementById('btn-record').onclick = () => {
                if (!isRecording) {
                    recognition.start();
                    document.getElementById('record-text').innerText = "æ­£åœ¨å€¾å¬...";
                    document.getElementById('mic-icon').innerText = "ğŸ›‘";
                    isRecording = true;
                } else {
                    recognition.stop();
                    isRecording = false;
                }
            };

            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('user-input').value += text;
                document.getElementById('record-text').innerText = "è¯­éŸ³å¤è¿°";
                document.getElementById('mic-icon').innerText = "ğŸ™ï¸";
                isRecording = false;
            };
        }

        /** å­˜æ¡£ä¸å¥–åŠ± **/
        function saveData(text, feedback) {
            const dateStr = new Date().toISOString().split('T')[0];
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (userData.lastDate === yesterdayStr) {
                userData.streak += 1;
            } else if (userData.lastDate !== dateStr) {
                userData.streak = 1;
            }

            userData.lastDate = dateStr;
            userData.records[dateStr] = {
                title: currentStory.title,
                userText: text,
                aiFeedback: feedback
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
            updateDashboard();
            renderHeatmap();
            renderHistory();
        }

        function showAIResult(text) {
            document.getElementById('ai-section').classList.remove('hidden');
            document.getElementById('ai-feedback').innerText = text;
        }

        function updateDashboard() {
            const streak = userData.streak;
            document.getElementById('streak-count').innerText = streak;
            
            const levels = [
                {n: "åˆå…¥å²æ—", d: 1, e: "ğŸ‘¶"},
                {n: "æ‰§ç¬”æ ¡å°‰", d: 3, e: "ğŸ“œ"},
                {n: "å†…é˜è¾…è‡£", d: 7, e: "âš–ï¸"},
                {n: "é€»è¾‘å¸å¸ˆ", d: 15, e: "ğŸ§ "},
                {n: "å²ç­–åœ£æ‰‹", d: 30, e: "ğŸ‘‘"}
            ];
            
            let title = levels[0].n;
            levels.forEach(l => { if(streak >= l.d) title = l.n; });
            document.getElementById('user-title').innerText = title;

            const listHtml = levels.map(l => `
                <div class="flex items-center justify-between ${streak >= l.d ? 'opacity-100' : 'opacity-30'}">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${l.e}</span>
                        <div>
                            <p class="text-sm font-bold">${l.n}</p>
                            <p class="text-[10px] text-gray-500">è¿ç»­åšæŒ ${l.d} å¤©</p>
                        </div>
                    </div>
                    ${streak >= l.d ? 'âœ…' : 'ğŸ”’'}
                </div>
            `).join('');
            document.getElementById('achievement-list').innerHTML = listHtml;
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            const today = new Date();
            for (let i = 27; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dStr = d.toISOString().split('T')[0];
                const active = userData.records[dStr];
                const cell = document.createElement('div');
                cell.className = `heat-cell ${active ? 'bg-fill' : 'bg-empty'}`;
                cell.title = dStr;
                container.appendChild(cell);
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            const dates = Object.keys(userData.records).sort().reverse();
            container.innerHTML = dates.map(date => {
                const r = userData.records[date];
                return `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-mono text-gray-400">${date}</span>
                            <span class="text-xs font-bold text-indigo-500">${r.title}</span>
                        </div>
                        <p class="text-xs text-gray-600 line-clamp-2 mb-3">â€œ${r.userText}â€</p>
                        <details class="group">
                            <summary class="text-[10px] text-indigo-400 cursor-pointer outline-none">å±•å¼€åˆ¤å®˜é”è¯„</summary>
                            <div class="mt-2 text-[11px] text-slate-500 bg-slate-50 p-3 rounded-lg leading-relaxed border-l-2 border-indigo-200 whitespace-pre-line">
                                ${r.aiFeedback}
                            </div>
                        </details>
                    </div>
                `;
            }).join('') || '<p class="text-center text-gray-400 text-sm py-10">å°šæ— å­˜æ¡£ï¼Œå¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡ç»ƒä¹ å§</p>';
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.className = 'text-gray-500 pb-1');
            document.getElementById(id).classList.add('active');
            document.getElementById('tab-' + id).className = 'text-indigo-600 border-b-2 border-indigo-600 pb-1';
        }
    </script>
</body>
</html>