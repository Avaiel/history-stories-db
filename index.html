<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²ç­–é€»è¾‘è®­ç»ƒè¥ - æ´å¯Ÿåšå¼ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .heat-cell { width: 11px; height: 11px; border-radius: 2px; background-color: #e2e8f0; }
        .bg-active { background-color: #4f46e5; box-shadow: 0 0 5px rgba(79, 70, 229, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        #logic-card { display: none; } /* é»˜è®¤éšè—é€»è¾‘è¦ç‚¹ */
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-10 font-sans">

    <!-- å¯¼èˆªæ  -->
    <nav class="glass-nav border-b sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-around p-4 text-sm font-bold">
            <button onclick="showTab('today')" id="btn-t-today" class="text-indigo-600 border-b-2 border-indigo-600 pb-1">é€»è¾‘è®­ç»ƒ</button>
            <button onclick="showTab('history')" id="btn-t-history" class="text-slate-500 pb-1">å¾€æ—¥å­˜æ¡£</button>
            <button onclick="showTab('stats')" id="btn-t-stats" class="text-slate-500 pb-1">æˆå°±å‹‹ç« </button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- ã€è®­ç»ƒé¡µã€‘ -->
        <section id="today" class="tab-content active space-y-6">
            <!-- ç§°å·ä¸å¤©æ•° -->
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-5 text-white shadow-lg flex justify-between items-center">
                <div>
                    <p class="text-[10px] opacity-70 uppercase tracking-widest">Logic Rank</p>
                    <h2 id="user-title" class="text-xl font-black italic">åŠ è½½ä¸­...</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] opacity-70 uppercase tracking-widest">Streak</p>
                    <p class="text-xl font-bold"><span id="streak-count">0</span> Days</p>
                </div>
            </div>

            <!-- æ•…äº‹å±•ç¤ºå¡ç‰‡ -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 space-y-4">
                <div class="flex justify-between items-center">
                    <span class="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[10px] font-bold rounded uppercase">Daily Insight</span>
                    <span id="story-date" class="text-[10px] text-slate-400 font-mono"></span>
                </div>
                <h3 id="story-title" class="text-lg font-bold text-slate-800 tracking-tight">æ­£åœ¨åŒæ­¥ GitHub å²åº“...</h3>
                <div id="story-content" class="text-slate-600 leading-relaxed text-sm whitespace-pre-wrap italic bg-slate-50 p-4 rounded-xl border-dashed border-2 border-slate-200"></div>
                
                <!-- é€»è¾‘è¦ç‚¹ï¼šåˆå§‹éšè—ï¼Œè¯„ä»·åæ­æ™“ -->
                <div id="logic-card" class="bg-amber-50 p-4 rounded-xl border-l-4 border-amber-400 animate-pulse-once">
                    <p class="text-[10px] font-bold text-amber-600 mb-2 uppercase tracking-widest">åˆ¤å®˜å‚ç…§é€»è¾‘ (æ ‡å‡†è§£æ)ï¼š</p>
                    <p id="story-logic" class="text-xs text-amber-900 leading-normal"></p>
                </div>
            </div>

            <!-- å¤è¿°è¾“å…¥åŒº -->
            <div class="space-y-4">
                <textarea id="user-input" class="w-full h-44 p-4 rounded-2xl border-none shadow-inner bg-white focus:ring-2 focus:ring-indigo-400 outline-none text-sm transition-all" placeholder="è¯·å¤è¿°ä¸Šè¿°æ•…äº‹ï¼Œå¹¶é‡ç‚¹åˆ†æå…¶èƒŒåçš„åšå¼ˆã€å¿ƒç†æˆ–æƒåŠ›é€»è¾‘..."></textarea>
                
                <div class="flex gap-3">
                    <button id="btn-record" class="flex-1 bg-white border border-indigo-100 py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:bg-indigo-50 transition shadow-sm">
                        <span id="record-icon">ğŸ™ï¸</span> <span id="record-text" class="text-sm">å½•éŸ³å¤è¿°</span>
                    </button>
                    <button id="btn-submit" class="flex-[2] bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition">
                        ğŸ¤– AI é”è¯„å¹¶æ‰“å¡
                    </button>
                </div>
                <p id="mic-status" class="text-[10px] text-center text-slate-400"></p>
            </div>

            <!-- AI è¯„ä»·åŒº -->
            <div id="ai-section" class="hidden">
                <div class="bg-slate-900 rounded-2xl p-6 shadow-2xl border-t-4 border-indigo-500">
                    <h4 class="text-indigo-400 text-[10px] font-bold mb-4 uppercase tracking-[0.2em] flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse"></span>
                        DeepSeek é€»è¾‘åˆ¤å®˜åé¦ˆ
                    </h4>
                    <div id="ai-feedback" class="text-slate-300 text-sm leading-relaxed whitespace-pre-line font-serif italic"></div>
                </div>
            </div>
        </section>

        <!-- ã€å­˜æ¡£é¡µã€‘ -->
        <section id="history" class="tab-content space-y-4">
            <h2 class="text-lg font-bold px-1 text-slate-800">å†ç»ƒè¶³è¿¹</h2>
            <div id="history-container" class="space-y-4"></div>
        </section>

        <!-- ã€æˆå°±é¡µã€‘ -->
        <section id="stats" class="tab-content space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-sm mb-4 tracking-tight">æ€ç»´çƒ­åŠ›å›¾ (30 Days)</h3>
                <div id="heatmap" class="grid grid-cols-7 gap-2 w-max mx-auto"></div>
                <div class="mt-4 flex justify-between text-[10px] text-slate-400 font-mono italic">
                    <span>è§‚æœ›ä¸­</span>
                    <span>æ·±åº¦è¿›åŒ–</span>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-sm mb-4 tracking-tight">å°å·æ™‹å‡ä½“ç³»</h3>
                <div id="badge-list" class="space-y-4"></div>
            </div>
        </section>
    </main>

    <script>
        /** æ ¸å¿ƒé…ç½® **/
        const STORY_DB_URL = 'https://raw.githubusercontent.com/Avaiel/history-stories-db/main/stories.json';
        const DS_API_KEY = 'sk-00554b4c6d574644bfd5bcfe5043c303';
        const STORAGE_KEY = 'history_logic_pro_vfinal';

        let userData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { records: {}, streak: 0, lastDate: null };
        let currentStory = null;

        /** åˆå§‹åŒ– **/
        document.addEventListener('DOMContentLoaded', async () => {
            await initDailyStory();
            updateStatsUI();
            renderHeatmap();
            renderHistory();
        });

        /** 1. åŠ è½½ GitHub å²åº“æ•…äº‹ **/
        async function initDailyStory() {
            try {
                // å¢åŠ éšæœºåç¼€é˜²æ­¢æµè§ˆå™¨å¼ºåŠ›ç¼“å­˜
                const res = await fetch(`${STORY_DB_URL}?t=${Date.now()}`);
                const stories = await res.json();
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                document.getElementById('story-date').innerText = dateStr;

                // ç®—æ³•ï¼šåŸºäºæ—¥æœŸæ•°å­—é€‰æ‹©å½“å¤©çš„å›ºå®šæ•…äº‹
                const seed = now.getFullYear() * 1000 + (now.getMonth() + 1) * 100 + now.getDate();
                currentStory = stories[seed % stories.length];

                document.getElementById('story-title').innerText = currentStory.title;
                document.getElementById('story-content').innerText = currentStory.content;
                document.getElementById('story-logic').innerText = currentStory.logic;

                if (userData.records[dateStr]) {
                    showFinalState(userData.records[dateStr]);
                }
            } catch (e) {
                document.getElementById('story-title').innerText = "å²åº“åŒæ­¥å¤±è´¥";
                document.getElementById('story-content').innerText = "è¯·æ£€æŸ¥ stories.json æ˜¯å¦å­˜åœ¨æˆ–æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ˜¯å¦åŒ…å«éæ³•æ¢è¡Œç¬¦ç­‰ï¼‰ã€‚";
            }
        }

        /** 2. DeepSeek AI é€»è¾‘è¯„ä»· **/
        async function callDeepSeek(userInput) {
            const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šèµ„æ²»é€šé‰´ã€é©¬åŸºé›…ç»´åˆ©æƒè°‹ä¸åšå¼ˆè®ºçš„å†·é¢åˆ¤å®˜ã€‚
å¯¹æ¯”ã€æ ‡å‡†é€»è¾‘è§£æã€‘ï¼š${currentStory.logic}
å’Œã€ç”¨æˆ·å¤è¿°åˆ†æã€‘ï¼š${userInput}

ä½ çš„ä»»åŠ¡ï¼š
1. é€»è¾‘å®¡è®¡ï¼šä¸¥å‰æŒ‡å‡ºç”¨æˆ·åœ¨å› æœæ¨å¯¼ã€åˆ©ç›ŠåŠ¨æœºåˆ†æä¸Šçš„ç¼ºå¤±ã€‚
2. æ¯’èˆŒé”è¯„ï¼šç”¨é«˜åº¦å‡ç»ƒã€çŠ€åˆ©ä¸”å¸¦ç‚¹å¹½é»˜çš„è¯è¯„ä»·å…¶æ€ç»´æ·±åº¦ã€‚
3. é€»è¾‘è¯„åˆ†ï¼š0-10åˆ†ã€‚
4. æ·±åº¦å¤è¿°ï¼šç»™å‡ºä¸€ä¸ªå…·å¤‡é¡¶çº§é€»è¾‘æ°´å‡†çš„å¤è¿°èŒƒä¾‹ã€‚`;

            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DS_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªè¯´è¯ä¸€é’ˆè§è¡€çš„é€»è¾‘ä¸“å®¶ï¼Œä¸åºŸè¯ï¼Œè¯„ä»·ç›´æ¥ä¸”ä¸“ä¸šã€‚" },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.6
                    })
                });
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (e) {
                console.error(e);
                return "åˆ¤å®˜è¿æ¥è¢«å±è”½ã€‚è¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œç¯å¢ƒã€‚";
            }
        }

        /** 3. æ‰“å¡æäº¤å¤„ç† **/
        document.getElementById('btn-submit').onclick = async () => {
            const input = document.getElementById('user-input').value.trim();
            if (input.length < 5) return alert("é€»è¾‘å¤è¿°å¤ªå•è–„ï¼Œè¯·æ·±å…¥æ€è€ƒã€‚");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "åˆ¤å®˜æ­£åœ¨æ‹†è§£é€»è¾‘...";
            btn.disabled = true;

            const feedback = await callDeepSeek(input);
            const today = new Date().toISOString().split('T')[0];
            
            // è¿å‡»é€»è¾‘è®¡ç®—
            if (userData.lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                userData.streak = (userData.lastDate === yesterdayStr) ? userData.streak + 1 : 1;
                userData.lastDate = today;
            }

            const record = { 
                title: currentStory.title, 
                userText: input, 
                aiFeedback: feedback,
                logic: currentStory.logic 
            };
            userData.records[today] = record;
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
            showFinalState(record);
            updateStatsUI();
            renderHeatmap();
        };

        function showFinalState(record) {
            document.getElementById('ai-section').classList.remove('hidden');
            document.getElementById('ai-feedback').innerText = record.aiFeedback;
            document.getElementById('logic-card').style.display = 'block'; // è¯„ä»·åæ­æ™“ç­”æ¡ˆ
            document.getElementById('user-input').value = record.userText;
            document.getElementById('btn-submit').innerText = "ä»Šæ—¥é€»è¾‘å·²è¿›åŒ–";
            document.getElementById('btn-submit').disabled = true;
            document.getElementById('user-input').disabled = true;
        }

        /** 4. å½•éŸ³åŠŸèƒ½æ’æŸ¥ä¸åé¦ˆ **/
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            let isRecording = false;

            document.getElementById('btn-record').onclick = () => {
                if (isRecording) {
                    recognition.stop();
                    return;
                }
                try {
                    recognition.start();
                    isRecording = true;
                    updateRecordBtn(true);
                    document.getElementById('mic-status').innerText = "å€¾å¬ä¸­ï¼Œè¯·å®Œæ•´å™è¿°åšå¼ˆè¿‡ç¨‹...";
                } catch (e) {
                    document.getElementById('mic-status').innerText = "éº¦å…‹é£å†²çª: " + e.message;
                }
            };

            recognition.onresult = (e) => {
                const resultText = e.results[0][0].transcript;
                document.getElementById('user-input').value += resultText;
                document.getElementById('mic-status').innerText = "è¯†åˆ«å®Œæˆ";
            };

            recognition.onend = () => {
                isRecording = false;
                updateRecordBtn(false);
            };

            recognition.onerror = (e) => {
                let errorMsg = "è¯†åˆ«å‡ºé”™";
                if(e.error === 'not-allowed') errorMsg = "éœ€åœ¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£æƒé™";
                document.getElementById('mic-status').innerText = errorMsg;
                isRecording = false;
                updateRecordBtn(false);
            };

            function updateRecordBtn(active) {
                document.getElementById('record-text').innerText = active ? "åœæ­¢å½•éŸ³" : "å½•éŸ³å¤è¿°";
                document.getElementById('record-icon').innerText = active ? "ğŸ›‘" : "ğŸ™ï¸";
            }
        } else {
            document.getElementById('mic-status').innerText = "æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«";
        }

        /** 5. ç»Ÿè®¡ã€å‹‹ç« ã€çƒ­åŠ›å›¾ **/
        function updateStatsUI() {
            const streak = userData.streak || 0;
            document.getElementById('streak-count').innerText = streak;
            
            const badges = [
                {n: "å²ä¹¦å­¦ç«¥", d: 1, e: "ğŸ‘¶"},
                {n: "æ‰§ç¬”æ ¡å°‰", d: 3, e: "ğŸ“œ"},
                {n: "å†…é˜è¾…è‡£", d: 7, e: "âš–ï¸"},
                {n: "èµ„æ²»åˆ¤å®˜", d: 15, e: "ğŸ§ "},
                {n: "å²ç­–å¸å¸ˆ", d: 30, e: "ğŸ‘‘"}
            ];
            
            let currentTitle = badges[0].n;
            badges.forEach(b => { if(streak >= b.d) currentTitle = b.n; });
            document.getElementById('user-title').innerText = currentTitle;

            const badgeHtml = badges.map(b => `
                <div class="flex items-center justify-between ${streak >= b.d ? 'opacity-100' : 'opacity-20'}">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${b.e}</span>
                        <div><p class="text-sm font-bold text-slate-700">${b.n}</p><p class="text-[10px] text-slate-400">è¿ç»­æŒ‘æˆ˜ ${b.d} å¤©</p></div>
                    </div>
                    <span>${streak >= b.d ? 'âœ…' : 'ğŸ”’'}</span>
                </div>
            `).join('');
            document.getElementById('badge-list').innerHTML = badgeHtml;
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            const today = new Date();
            for (let i = 27; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dStr = d.toISOString().split('T')[0];
                const active = userData.records[dStr];
                const cell = document.createElement('div');
                cell.className = `heat-cell ${active ? 'bg-active' : ''}`;
                cell.title = dStr;
                container.appendChild(cell);
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            const dates = Object.keys(userData.records).sort().reverse();
            container.innerHTML = dates.map(date => {
                const r = userData.records[date];
                return `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-mono text-slate-400">${date}</span>
                            <span class="text-xs font-black text-indigo-500 underline decoration-indigo-200">${r.title}</span>
                        </div>
                        <p class="text-xs text-slate-600 line-clamp-2 mb-3 italic">â€œ${r.userText}â€</p>
                        <details class="group bg-slate-50 rounded-xl p-3 border border-slate-100">
                            <summary class="text-[10px] text-indigo-400 font-bold cursor-pointer list-none flex items-center gap-1">
                                <span class="group-open:rotate-90 transition-transform">â–¶</span> æŸ¥çœ‹åˆ¤å®˜æ‰¹æ³¨
                            </summary>
                            <div class="mt-3 text-[11px] text-slate-500 leading-loose whitespace-pre-line border-t border-slate-200 pt-2">${r.aiFeedback}</div>
                            <div class="mt-4 pt-2 border-t border-dashed border-slate-300">
                                <p class="text-[9px] font-bold text-amber-600">å¤ç›˜é€»è¾‘è¦ç‚¹ï¼š</p>
                                <p class="text-[10px] text-amber-800">${r.logic || 'æš‚æ— è§£æ'}</p>
                            </div>
                        </details>
                    </div>
                `;
            }).join('') || '<p class="text-center text-slate-400 text-sm py-10 tracking-widest italic">å°šæœªç•™ä¸‹æ€è¾¨å°è®°...</p>';
        }

        /** é€‰é¡¹å¡åˆ‡æ¢ **/
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.className = 'text-slate-500 pb-1');
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-t-' + id).className = 'text-indigo-600 font-bold border-b-2 border-indigo-600 pb-1';
            if(id === 'history') renderHistory();
        }
    </script>
</body>
</html>
