<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²ç­–é€»è¾‘è®­ç»ƒè¥ - æ·±åº¦å¤ç›˜ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .heat-cell { width: 11px; height: 11px; border-radius: 2px; background-color: #e2e8f0; }
        .bg-active { background-color: #4f46e5; box-shadow: 0 0 5px rgba(79, 70, 229, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        #logic-card { display: none; } 
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        
        /* åˆ¤å®˜åé¦ˆæ ·å¼æ¸²æŸ“ä¼˜åŒ– */
        .feedback-content h5 { color: #a5b4fc; font-weight: 800; margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 0.85rem; letter-spacing: 0.1em; border-bottom: 1px solid #334155; padding-bottom: 4px; text-transform: uppercase; }
        .feedback-content strong { color: #ffffff; font-weight: 700; background: rgba(99, 102, 241, 0.2); padding: 0 2px; border-radius: 2px; }
        .feedback-content blockquote { border-left: 4px solid #6366f1; padding: 0.5rem 1rem; font-style: italic; color: #cbd5e1; margin: 1rem 0; background: rgba(30, 41, 59, 0.5); border-radius: 0 8px 8px 0; }
        .feedback-content p { margin-bottom: 0.75rem; line-height: 1.7; }
        /* ä¸“é—¨ä¸ºâ€œæœ¯è¯­æµ…æâ€è®¾è®¡çš„æ ·å¼ */
        .term-box { background: rgba(16, 185, 129, 0.1); border: 1px border #10b981; padding: 10px; border-radius: 8px; margin-top: 10px; color: #d1fae5; font-size: 0.75rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-10 font-sans leading-relaxed">

    <!-- å¯¼èˆªæ  -->
    <nav class="glass-nav border-b sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-around p-4 text-sm font-bold">
            <button onclick="showTab('today')" id="btn-t-today" class="text-indigo-600 border-b-2 border-indigo-600 pb-1">é€»è¾‘è®­ç»ƒ</button>
            <button onclick="showTab('history')" id="btn-t-history" class="text-slate-500 pb-1">å¾€æ—¥å­˜æ¡£</button>
            <button onclick="showTab('stats')" id="btn-t-stats" class="text-slate-500 pb-1">æˆå°±å‹‹ç« </button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- ã€è®­ç»ƒé¡µã€‘ -->
        <section id="today" class="tab-content active space-y-6">
            <!-- ç§°å·å±•ç¤º -->
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl p-6 text-white shadow-xl flex justify-between items-center">
                <div>
                    <p class="text-[10px] opacity-70 uppercase tracking-widest mb-1">Logic Rank</p>
                    <h2 id="user-title" class="text-xl font-black italic tracking-tight">åŠ è½½ä¸­...</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] opacity-70 uppercase tracking-widest mb-1">Streak</p>
                    <p class="text-2xl font-bold"><span id="streak-count">0</span> <span class="text-xs">Days</span></p>
                </div>
            </div>

            <!-- æ•…äº‹å±•ç¤ºå¡ç‰‡ -->
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 space-y-4">
                <div class="flex justify-between items-center">
                    <span class="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[10px] font-bold rounded uppercase">Daily Story</span>
                    <span id="story-date" class="text-[10px] text-slate-400 font-mono"></span>
                </div>
                <h3 id="story-title" class="text-lg font-bold text-slate-800 tracking-tight leading-snug">æ­£åœ¨ç¿»é˜…å²åº“...</h3>
                <div id="story-content" class="text-slate-600 text-sm whitespace-pre-wrap italic bg-slate-50 p-5 rounded-2xl border-dashed border-2 border-slate-200 leading-relaxed shadow-inner"></div>
                
                <!-- é€»è¾‘è¦ç‚¹ï¼šè¯„ä»·åæ­æ™“ -->
                <div id="logic-card" class="bg-amber-50 p-4 rounded-xl border-l-4 border-amber-400">
                    <p class="text-[10px] font-bold text-amber-600 mb-2 uppercase tracking-widest">åˆ¤å®˜å‚ç…§é€»è¾‘ï¼š</p>
                    <p id="story-logic" class="text-xs text-amber-900 leading-normal"></p>
                </div>
            </div>

            <!-- å¤è¿°è¾“å…¥åŒº -->
            <div class="space-y-4">
                <textarea id="user-input" class="w-full h-48 p-5 rounded-3xl border-none shadow-inner bg-white focus:ring-2 focus:ring-indigo-400 outline-none text-sm transition-all" placeholder="è¯·åœ¨æ­¤å¤è¿°æ•…äº‹é€»è¾‘ï¼Œå°è¯•ç”¨åšå¼ˆå’ŒåŠ¨æœºè§†è§’åˆ†æ..."></textarea>
                <button id="btn-submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all text-sm tracking-widest">
                    ğŸ¤– æäº¤å¹¶å¬å”¤ AI åˆ¤å®˜
                </button>
            </div>

            <!-- AI è¯„ä»·åé¦ˆåŒº -->
            <div id="ai-section" class="hidden space-y-6">
                <div class="bg-slate-900 rounded-[2.5rem] p-7 shadow-2xl border-t-8 border-indigo-500 relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 p-8 opacity-5 font-black text-6xl text-white select-none italic tracking-tighter">ANALYSIS</div>
                    <h4 class="text-indigo-400 text-[10px] font-bold mb-4 uppercase tracking-[0.3em] flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-pulse"></span>
                        åˆ¤å®˜æ·±åº¦åé¦ˆ
                    </h4>
                    <div id="ai-feedback" class="feedback-content text-slate-300 text-sm font-serif"></div>
                </div>

                <!-- ä¸ªäººå¤ç›˜ç¬”è®° -->
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200 space-y-4">
                    <h4 class="text-slate-800 text-xs font-bold flex items-center gap-2">
                        <span class="text-base">ğŸ“</span> ä¸ªäººè¿›åŒ–ç¬”è®°
                    </h4>
                    <textarea id="personal-note" class="w-full h-32 p-4 text-sm bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-200 outline-none placeholder:text-slate-300 shadow-inner" placeholder="ä»Šå¤©å­¦åˆ°äº†ä»€ä¹ˆæ–°çš„é€»è¾‘ç‚¹ï¼Ÿåˆ¤å®˜çº æ­£äº†ä½ å“ªä¸ªæ€ç»´ç›²åŒºï¼Ÿ"></textarea>
                    <div class="flex items-center gap-3">
                        <button onclick="savePersonalNote()" class="text-[10px] bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-700 transition shadow-md">ä¿å­˜å¤ç›˜å†…å®¹</button>
                        <p id="save-status" class="text-[9px] text-green-500 hidden font-bold animate-bounce">âœ“ ç¬”è®°å·²åŒæ­¥è‡³å­˜æ¡£</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ã€å­˜æ¡£é¡µã€‘ -->
        <section id="history" class="tab-content space-y-4">
            <h2 class="text-lg font-bold px-1 text-slate-800">å†ç»ƒå­˜æ¡£</h2>
            <div id="history-container" class="space-y-4"></div>
        </section>

        <!-- ã€æˆå°±é¡µã€‘ -->
        <section id="stats" class="tab-content space-y-6">
            <div class="bg-white rounded-3xl p-7 shadow-sm border border-slate-100">
                <h3 class="font-bold text-sm mb-5 text-center text-slate-700">æ€ç»´è¿›åŒ–çƒ­åŠ›å›¾</h3>
                <div id="heatmap" class="grid grid-cols-7 gap-2.5 w-max mx-auto"></div>
                <div class="mt-5 flex justify-between text-[9px] text-slate-400 font-mono tracking-tighter px-2">
                    <span>è§‚æœ› (NONE)</span>
                    <span>æ·±åº¦è¿›åŒ– (LOGIC)</span>
                </div>
            </div>
            <div class="bg-white rounded-3xl p-7 shadow-sm border border-slate-100">
                <h3 class="font-bold text-sm mb-5 text-slate-700">è£èª‰ä½“ç³»</h3>
                <div id="badge-list" class="space-y-5"></div>
            </div>
        </section>
    </main>

    <script>
        const STORY_DB_URL = 'https://raw.githubusercontent.com/Avaiel/history-stories-db/main/stories.json';
        const DS_API_KEY = 'sk-00554b4c6d574644bfd5bcfe5043c303';
        const STORAGE_KEY = 'history_logic_pro_v_notes_v2';

        let userData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { records: {}, streak: 0, lastDate: null };
        let currentStory = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await initDailyStory();
            updateStatsUI();
            renderHeatmap();
            renderHistory();
        });

        // æ ¼å¼åŒ–åˆ¤å®˜è¾“å‡ºï¼Œå¤„ç†æœ¯è¯­æµ…ææ¿å—
        function formatJudgeOutput(text) {
            let html = text
                .replace(/^### (.*$)/gim, '<h5>$1</h5>') 
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/> (.*$)/gim, '<blockquote>$1</blockquote>') 
                .replace(/\n/g, '<br>');
            
            // å¦‚æœåŒ…å«â€œæœ¯è¯­æµ…æâ€ï¼Œå°†å…¶æ”¾å…¥ä¸€ä¸ªç‰¹æ®Šçš„ç»¿è‰²æ¡†ä¸­
            if (html.includes('æœ¯è¯­æµ…æ')) {
                html = html.replace('<h5>æœ¯è¯­æµ…æ</h5>', '<div class="term-box"><strong>ğŸ’¡ æœ¯è¯­é€šä¿—è§£é‡Š</strong><br>');
                html += '</div>';
            }
            return html;
        }

        async function initDailyStory() {
            try {
                const res = await fetch(`${STORY_DB_URL}?t=${Date.now()}`);
                const stories = await res.json();
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                document.getElementById('story-date').innerText = dateStr;

                const seed = now.getFullYear() * 1000 + (now.getMonth() + 1) * 100 + now.getDate();
                currentStory = stories[seed % stories.length];

                document.getElementById('story-title').innerText = currentStory.title;
                document.getElementById('story-content').innerText = currentStory.content;
                document.getElementById('story-logic').innerText = currentStory.logic;

                if (userData.records[dateStr]) {
                    showFinalState(userData.records[dateStr]);
                }
            } catch (e) { document.getElementById('story-title').innerText = "å²åº“åŒæ­¥ä¸­..."; }
        }

        async function callDeepSeek(userInput) {
            const prompt = `ä½ æ˜¯ä¸€ä½å†·é…·çš„å†å²åšå¼ˆåˆ¤å®˜ã€‚
å¯¹æ¯”ã€æ ‡å‡†é€»è¾‘ã€‘ï¼š${currentStory.logic}
å¯¹æ¯”ã€ç”¨æˆ·å¤è¿°ã€‘ï¼š${userInput}

è¯·æŒ‰æ­¤ç»“æ„è¾“å‡ºï¼Œä¸¥ç¦ä½¿ç”¨#æˆ–*ç­‰åŸå§‹ç¬¦å·ï¼š
### é€»è¾‘å®¡è®¡
(æŒ‡å‡ºç”¨æˆ·åˆ†æçš„æ¼æ´)
### æ¯’èˆŒé”è¯„
> (çŠ€åˆ©ä¸”å¹½é»˜çš„æ€»ç»“)
### é€»è¾‘è¯„åˆ†
(0-10)
### æœ¯è¯­æµ…æ
(å¦‚æœä½ åœ¨ä¸Šé¢ä½¿ç”¨äº†ä¸“ä¸šæœ¯è¯­å¦‚â€œæ²‰æ²¡æˆæœ¬â€ã€â€œçº³ä»€å‡è¡¡â€ã€â€œè·¯å¾„ä¾èµ–â€ã€â€œå¸•ç´¯æ‰˜æ”¹è¿›â€ã€â€œä¿¡æ¯ä¸å¯¹ç§°â€ç­‰ï¼Œè¯·åœ¨è¿™é‡Œç”¨å¤§ç™½è¯å’Œç”Ÿæ´»ä¾‹å­è§£é‡Šç»™å°ç™½å¬ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ï¼Œåˆ™è·³è¿‡æ­¤é¡¹ã€‚)
### é€»è¾‘èŒƒä¾‹
(æœ€é«˜æ°´å‡†çš„ç®€çŸ­å¤è¿°)`;

            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DS_API_KEY}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "system", content: "åˆ¤å®˜ä¸è¾“å‡ºMarkdownåŸå§‹ç¬¦å·ï¼Œåªè¾“å‡ºç»“æ„åŒ–çš„æ–‡å­—ã€‚" }, { role: "user", content: prompt }],
                        temperature: 0.6
                    })
                });
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (e) { return "åˆ¤å®˜è¿æ¥ä¸­æ–­ã€‚"; }
        }

        document.getElementById('btn-submit').onclick = async () => {
            const input = document.getElementById('user-input').value.trim();
            if (input.length < 5) return alert("å¤è¿°å¤ªçŸ­ï¼Œé€»è¾‘æ— æ³•åˆ¤å®šã€‚");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "åˆ¤å®˜æ­£åœ¨å®¡æ‰¹...";
            btn.disabled = true;

            const feedback = await callDeepSeek(input);
            const today = new Date().toISOString().split('T')[0];
            
            if (userData.lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                userData.streak = (userData.lastDate === yesterdayStr) ? userData.streak + 1 : 1;
                userData.lastDate = today;
            }

            const record = { 
                title: currentStory.title, 
                userText: input, 
                aiFeedback: feedback,
                logic: currentStory.logic,
                note: "" 
            };
            userData.records[today] = record;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
            
            showFinalState(record);
            updateStatsUI();
            renderHeatmap();
        };

        function showFinalState(record) {
            document.getElementById('ai-section').classList.remove('hidden');
            document.getElementById('ai-feedback').innerHTML = formatJudgeOutput(record.aiFeedback);
            document.getElementById('logic-card').style.display = 'block';
            document.getElementById('user-input').value = record.userText;
            document.getElementById('personal-note').value = record.note || "";
            document.getElementById('btn-submit').innerText = "ä»Šæ—¥æ‰“å¡å®Œæˆ";
            document.getElementById('btn-submit').disabled = true;
        }

        function savePersonalNote() {
            const today = new Date().toISOString().split('T')[0];
            if (userData.records[today]) {
                userData.records[today].note = document.getElementById('personal-note').value;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
                const status = document.getElementById('save-status');
                status.classList.remove('hidden');
                setTimeout(() => status.classList.add('hidden'), 2000);
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            const dates = Object.keys(userData.records).sort().reverse();
            container.innerHTML = dates.map(date => {
                const r = userData.records[date];
                return `
                    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-3 text-[10px] font-bold">
                            <span class="font-mono text-slate-300 uppercase tracking-widest">${date}</span>
                            <span class="text-indigo-500 underline decoration-indigo-100">${r.title}</span>
                        </div>
                        <p class="text-[11px] text-slate-400 mb-4 italic line-clamp-1">å¤è¿°ï¼š${r.userText}</p>
                        <details class="group">
                            <summary class="text-[10px] text-indigo-400 font-bold cursor-pointer list-none flex items-center gap-1">
                                <span class="group-open:rotate-90 transition-transform">â–¶</span> å±•å¼€æ·±åº¦å­˜æ¡£
                            </summary>
                            <div class="mt-4 p-5 bg-slate-900 text-slate-300 rounded-3xl text-[11px] feedback-content border-t-4 border-indigo-400">${formatJudgeOutput(r.aiFeedback)}</div>
                            ${r.note ? `
                                <div class="mt-4 p-4 bg-amber-50 rounded-2xl border border-amber-100 text-[11px]">
                                    <p class="text-amber-600 font-black mb-1">ğŸ’¡ ä¸ªäººå¤ç›˜æ€»ç»“ï¼š</p>
                                    <p class="text-amber-800">${r.note}</p>
                                </div>
                            ` : ''}
                        </details>
                    </div>
                `;
            }).join('') || '<p class="text-center text-slate-300 text-sm py-10 italic">å°šæœªå¼€å§‹é€»è¾‘ä¿®è¡Œ...</p>';
        }

        function updateStatsUI() {
            const streak = userData.streak || 0;
            document.getElementById('streak-count').innerText = streak;
            const badges = [
                {n: "å²ä¹¦å­¦ç«¥", d: 1, e: "ğŸ‘¶"}, {n: "æ‰§ç¬”æ ¡å°‰", d: 3, e: "ğŸ“œ"},
                {n: "å†…é˜è¾…è‡£", d: 7, e: "âš–ï¸"}, {n: "èµ„æ²»åˆ¤å®˜", d: 15, e: "ğŸ§ "}, {n: "å²ç­–å¸å¸ˆ", d: 30, e: "ğŸ‘‘"}
            ];
            let title = badges[0].n;
            badges.forEach(b => { if(streak >= b.d) title = b.n; });
            document.getElementById('user-title').innerText = title;
            document.getElementById('badge-list').innerHTML = badges.map(b => `
                <div class="flex items-center justify-between ${streak >= b.d ? 'opacity-100' : 'opacity-20'}">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl">${b.e}</span>
                        <div><p class="text-sm font-bold text-slate-700">${b.n}</p><p class="text-[9px] text-slate-400 uppercase tracking-widest">Target: ${b.d} Days</p></div>
                    </div>
                    <span>${streak >= b.d ? 'âœ¨' : 'ğŸ”’'}</span>
                </div>
            `).join('');
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            for (let i = 27; i >= 0; i--) {
                const d = new Date(); d.setDate(new Date().getDate() - i);
                const dStr = d.toISOString().split('T')[0];
                const active = userData.records[dStr];
                const cell = document.createElement('div');
                cell.className = `heat-cell ${active ? 'bg-active' : ''}`;
                container.appendChild(cell);
            }
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.className = 'text-slate-500 pb-1');
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-t-' + id).className = 'text-indigo-600 font-bold border-b-2 border-indigo-600 pb-1';
            if(id === 'history') renderHistory();
        }
    </script>
</body>
</html>
